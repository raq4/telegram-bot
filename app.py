// Telegram Ð±Ð¾Ñ‚ Ð½Ð° Node.js Ð´Ð»Ñ Vercel Serverless
const { Telegraf } = require('telegraf');
const { Redis } = require('@upstash/redis');

// Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Redis
const redis = new Redis({
  url: process.env.UPSTASH_REDIS_REST_URL,
  token: process.env.UPSTASH_REDIS_REST_TOKEN,
});

// Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð±Ð¾Ñ‚Ð°
const bot = new Telegraf(process.env.TELEGRAM_TOKEN);

// ÐšÐ¾Ð¼Ð°Ð½Ð´Ð° /start
bot.start(async (ctx) => {
  await ctx.reply('ðŸ¤– Ð‘Ð¾Ñ‚ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ð½Ð° Upstash + Vercel!');
  
  // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð² Redis
  await redis.set(`user:${ctx.from.id}`, JSON.stringify({
    id: ctx.from.id,
    username: ctx.from.username,
    first_name: ctx.from.first_name,
    last_seen: new Date().toISOString(),
  }));
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ñ‹Ñ… ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹
bot.on('text', async (ctx) => {
  const userMessage = ctx.message.text;
  
  // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ Ð² Redis
  const chatId = `chat:${ctx.from.id}`;
  await redis.lpush(chatId, `User: ${userMessage}`);
  await redis.ltrim(chatId, 0, 9); // Ð¥Ñ€Ð°Ð½Ð¸Ð¼ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ 10 ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹
  
  // Ð—Ð´ÐµÑÑŒ Ð¼Ð¾Ð¶Ð½Ð¾ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸ÑŽ Ñ Mistral AI
  const response = await fetch('https://api.mistral.ai/v1/chat/completions', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${process.env.MISTRAL_API_KEY}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      model: 'mistral-tiny',
      messages: [{ role: 'user', content: userMessage }],
    }),
  });
  
  if (response.ok) {
    const data = await response.json();
    const aiResponse = data.choices[0].message.content;
    
    // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð¾Ñ‚Ð²ÐµÑ‚ Ð² Redis
    await redis.lpush(chatId, `Bot: ${aiResponse}`);
    
    // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŽ
    await ctx.reply(aiResponse);
  } else {
    await ctx.reply('âš ï¸ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð·Ð°Ð¿Ñ€Ð¾ÑÐµ Ðº AI');
  }
});

// ÐšÐ¾Ð¼Ð°Ð½Ð´Ð° /stats (Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÑ‚ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÑƒ)
bot.command('stats', async (ctx) => {
  const userKey = `user:${ctx.from.id}`;
  const userData = await redis.get(userKey);
  
  if (userData) {
    await ctx.reply(`ðŸ“Š Ð’Ð°ÑˆÐ° ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ°:\nID: ${userData.id}\nÐ˜Ð¼Ñ: ${userData.first_name}\nÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹ Ñ€Ð°Ð·: ${userData.last_seen}`);
  }
});

// Ð­ÐºÑÐ¿Ð¾Ñ€Ñ‚ Ð´Ð»Ñ Vercel Serverless
module.exports = async (req, res) => {
  try {
    await bot.handleUpdate(req.body);
    res.status(200).send('OK');
  } catch (error) {
    console.error(error);
    res.status(500).send('Error');
  }
};
